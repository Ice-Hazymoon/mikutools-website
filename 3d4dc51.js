(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{1041:function(t,e,o){"use strict";var n=o(2),r=o(4),l=o(41),c=o(35),d=o(34),m=o(377),y=o(22),f=o(5),h=o(376),v=o(248),_=o(562),T=o(563),C=o(142),D=o(564),x=[],$=r(x.sort),k=r(x.push),w=f((function(){x.sort(void 0)})),O=f((function(){x.sort(null)})),N=v("sort"),L=!f((function(){if(C)return C<70;if(!(_&&_>3)){if(T)return!0;if(D)return D<603;var code,t,e,o,n="";for(code=65;code<76;code++){switch(t=String.fromCharCode(code),code){case 66:case 69:case 70:case 72:e=3;break;case 68:case 71:e=4;break;default:e=2}for(o=0;o<47;o++)x.push({k:t+o,v:e})}for(x.sort((function(a,b){return b.v-a.v})),o=0;o<x.length;o++)t=x[o].k.charAt(0),n.charAt(n.length-1)!==t&&(n+=t);return"DGBEFHACIJK"!==n}}));n({target:"Array",proto:!0,forced:w||!O||!N||!L},{sort:function(t){void 0!==t&&l(t);var e=c(this);if(L)return void 0===t?$(e):$(e,t);var o,n,r=[],f=d(e);for(n=0;n<f;n++)n in e&&k(r,e[n]);for(h(r,function(t){return function(e,o){return void 0===o?-1:void 0===e?1:void 0!==t?+t(e,o)||0:y(e)>y(o)?1:-1}}(t)),o=d(r),n=0;n<o;)e[n]=r[n++];for(;n<f;)m(e,n++);return e}})},1099:function(t,e,o){"use strict";var n=o(2),r=o(42).findIndex,l=o(247),c="findIndex",d=!0;c in[]&&Array(1)[c]((function(){d=!1})),n({target:"Array",proto:!0,forced:d},{findIndex:function(t){return r(this,t,arguments.length>1?arguments[1]:void 0)}}),l(c)},1565:function(t,e,o){t.exports={}},2898:function(t,e,o){"use strict";o(1565)},3097:function(t,e,o){"use strict";o.r(e);o(23),o(79);var n=o(3),r=(o(25),o(1041),o(69),o(13),o(58),o(1099),o(21),o(68),o(39),o(33),o(529),o(246),o(59),o(32),o(47)),l=o.n(r),c=o(370),d={name:"Pay",data:function(){return{planType:"vip",plan:null,payType:null,qrcodeDialog:{orderNo:null,visible:!1,timer:null,timeout:3e5,closeTime:0,closeTimer:null}}},computed:{planList:function(){var t=this;return this.$store.state.productList.filter((function(e){return e.type===t.planType&&e.is_available})).sort((function(t){return t.main&&-1}))},planTypeList:function(){return this.$store.state.productList.map((function(t){return{type:t.type,typeName:t.typeName}})).filter((function(t,e,o){return o.findIndex((function(e){return e.type===t.type}))===e}))},payTypeList:function(){return this.$store.state.payType}},beforeDestroy:function(){this.qrcodeDialog.timer&&clearInterval(this.qrcodeDialog.timer)},mounted:function(){var t=this;this.$store.commit("loadingComponent",!0),this.$store.dispatch("getProductList").then((function(){t.$store.commit("loadingComponent",!1),t.plan=t.planList[0]})).catch((function(e){t.$notify.error({title:"获取商品列表失败，请刷新页面重试",message:e.message}),t.$store.commit("loadingComponent",!1)})),this.$nextTick((function(){t.$store.state.isMobile?t.payType="aliwap":t.payType="alipc"}))},methods:{handleQrcodeDialogPayOk:function(){console.log("handleQrcodeDialogPayOk"),this.checkOrder(this.qrcodeDialog.orderNo)},handleQrcodeDialogClose:function(t){var e=this;console.log("handleQrcodeDialogClose"),this.qrcodeDialog.visible=!1,clearInterval(this.qrcodeDialog.timer),!0===t?(this.$alert("订单超时未确认，已自动关闭，如您已支付，请稍后在用户中心查看，期待您的再次光临","订单取消",{confirmButtonText:"确定",type:"warning"}),this.closeOrder(this.qrcodeDialog.orderNo),this.resetDialog()):this.$confirm("是否取消支付","取消支付",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.closeOrder(e.qrcodeDialog.orderNo),e.resetDialog(),e.$message.info("期待您的再次光临")})).catch((function(){}))},closeOrder:function(t){console.log("closeOrder"),this.$axios.post("/user/pay/closeOrder",{orderNo:t}).then((function(t){console.log("取消订单成功",t)})).catch((function(t){console.log("取消订单失败",t)}))},checkOrder:function(t){var e=this;this.$store.commit("loadingComponent",!0),console.log("checkOrder"),this.$axios.post("/user/pay/checkOrder",{orderNo:t}).then((function(t){var data=t.data.data;e.$store.commit("loadingComponent",!1),data.status?(e.resetDialog(),e.$notify.success({title:"支付成功",message:"订单已支付成功，期待您的再次光临"}),e.$router.replace({path:"/user/pay-result",query:{out_trade_no:data.out_trade_no}})):e.$notify.warning({title:"订单未支付",message:"请在支付成功后重新查询"})})).catch((function(t){e.$store.commit("loadingComponent",!1),e.$notify.error({title:"查询订单状态失败",message:t})}))},resetDialog:function(){this.qrcodeDialog.orderNo=null,this.qrcodeDialog.visible=!1,this.qrcodeDialog.timer&&clearInterval(this.qrcodeDialog.timer),this.qrcodeDialog.closeTime=0,this.qrcodeDialog.closeTimer&&clearInterval(this.qrcodeDialog.closeTimer)},submitOrder:function(){var t=this;return this.$store.state.user.meta.mail?this.plan?(this.$store.commit("loadingComponent",!0),void this.$axios.post("/user/pay/createOrder",{product:this.plan.key,payType:this.payType}).then((function(e){t.$store.commit("loadingComponent",!1),t.qrcodeDialog.orderNo=e.data.orderNo,"wxpc"===t.payType?t.submitWxpayOrderPc(e.data):"wxwap"===t.payType?t.submitWxpayOrderWap(e.data):("alipc"===t.payType||"aliwap"===t.payType)&&t.submitAlipayOrder(e.data)})).catch((function(e){t.$store.commit("loadingComponent",!1),t.$notify.error({title:"提交订单失败",message:e})}))):this.$notify.error({title:"未选择商品",message:"请选择商品后购买"}):this.$notify.error({title:"未登录",message:"请登陆后购买"})},submitWxpayOrderPc:function(data){var t=this;console.log(data),this.qrcodeDialog.visible=!0,console.log(this.$store.state.env.axios),this.qrcodeDialog.qrcode=new URL(data.data,this.$store.state.env.axios).href,this.qrcodeDialog.closeTime=Date.now()+this.qrcodeDialog.timeout,this.qrcodeDialog.timer=setInterval((function(){var e=Date.now();console.log(e,t.qrcodeDialog.closeTime),e>=t.qrcodeDialog.closeTime&&t.handleQrcodeDialogClose(!0),t.qrcodeDialog.closeTimer=l()(t.qrcodeDialog.closeTime-e).format("mm:ss")}),1e3)},submitWxpayOrderWap:function(data){var t=this;setTimeout(Object(n.a)(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:window.open("".concat(t.$store.state.env.pay_redirect,"?url=").concat(encodeURIComponent(data.data)),"_top");case 1:case"end":return e.stop()}}),e)})))),this.$confirm("请在新页面中进行支付","提示",{confirmButtonText:"支付成功",cancelButtonText:"支付失败",type:"warning"}).then((function(){t.checkOrder(data.orderNo)})).catch((function(){t.$message({type:"info",message:"已取消订单"}),t.$axios.post("/user/pay/closeOrder",{orderNo:data.orderNo}).then((function(t){console.log(t)})).catch((function(t){console.log(t)}))}))},submitAlipayOrder:function(data){var t=this,e=this.$refs["alipay-form"];e.innerHTML=data.data,e.querySelector("form").target="_self",e.querySelector("form").submit(),e.innerHTML="",this.$confirm("请在新页面中进行支付","提示",{confirmButtonText:"支付成功",cancelButtonText:"支付失败",type:"warning"}).then((function(){t.checkOrder(data.orderNo)})).catch((function(){t.$message({type:"info",message:"已取消订单"}),t.$axios.post("/user/pay/closeOrder",{orderNo:data.orderNo}).then((function(t){console.log(t)})).catch((function(t){console.log(t)}))}))},saveQrcode:function(){c.a.bind(this)({url:this.qrcodeDialog.qrcode,filename:"qrcode.png"})}}},m=(o(2898),o(6)),component=Object(m.a)(d,(function(){var t=this,e=t._self._c;return e("div",{staticClass:"pay"},[e("client-only",[e("div",[t.plan?[e("el-dialog",{staticClass:"qrcode-dialog",attrs:{title:t.plan.name,top:"20vh",visible:t.qrcodeDialog.visible,width:"400px","before-close":t.handleQrcodeDialogClose},on:{"update:visible":function(e){return t.$set(t.qrcodeDialog,"visible",e)}}},[e("div",{staticClass:"qrcode-box"},[e("div",{staticClass:"qrcode-header mb-10"},[e("div",[t._v("￥"+t._s(t.plan.price))])]),e("div",{staticClass:"qrcode-img-box"},[e("img",{staticClass:"qrcode-img",attrs:{src:t.qrcodeDialog.qrcode,alt:""}}),e("img",{staticClass:"qrcode-logo",attrs:{src:o(389),alt:""}})])]),e("div",{staticClass:"mt-10 qrcode-text"},[t._v("\n                        使用微信扫一扫完成支付\n                    ")]),e("div",{staticClass:"qrcode-subtext mt-10"},[t._v("\n                        订单将在 "),e("span",{staticClass:"qrcode-subtext-timber"},[t._v(t._s(t.qrcodeDialog.closeTimer))]),t._v(" 后关闭\n                    ")]),e("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{attrs:{size:"small"},on:{click:t.handleQrcodeDialogClose}},[t._v("取消支付")]),e("el-button",{attrs:{size:"small",type:"primary"},on:{click:t.handleQrcodeDialogPayOk}},[t._v("支付成功")])],1)])]:t._e(),e("div",{ref:"alipay-form",staticClass:"alipay-form"}),e("nya-container",{attrs:{main:"",title:"捐赠购买"}},[t.planTypeList.length>1?e("div",{staticClass:"plan-type mb-15"},[e("el-radio-group",{attrs:{size:"mini"},model:{value:t.planType,callback:function(e){t.planType=e},expression:"planType"}},t._l(t.planTypeList,(function(o,n){return e("el-radio-button",{key:n,attrs:{label:o.type}},[t._v("\n                            "+t._s(o.typeName)+"\n                        ")])})),1)],1):t._e(),e("div",{staticClass:"nya-subtitle mt-15"},[t._v("\n                    选择商品\n                ")]),t.plan?e("div",{staticClass:"plan-box"},t._l(t.planList,(function(o,n){return e("el-radio",{key:n,staticClass:"plan-card",attrs:{label:o,disabled:!o.is_available,title:o.buyName},model:{value:t.plan,callback:function(e){t.plan=e},expression:"plan"}},[e("div",{staticClass:"plan-title"},[t._v("\n                            "+t._s(o.planName)+"\n                        ")]),e("div",{staticClass:"plan-price"},[e("span",[t._v("￥"+t._s(o.price))]),e("span",[t._v("/")]),e("span",[t._v(t._s(o.countText))])]),e("div",{staticClass:"plan-desc"},[e("ul",{staticClass:"nya-list"},t._l(o.desc,(function(desc,o){return e("li",{key:o},[e("span",[t._v(t._s(desc))])])})),0)])])})),1):e("el-skeleton",{staticClass:"mt-20"}),e("el-divider"),e("div",{staticClass:"nya-subtitle mt-15"},[t._v("\n                    确认信息\n                ")]),e("ul",{staticClass:"nya-list mt-15"},[e("li",[t._v("邮箱："),e("span",[t._v(t._s(t.$store.state.user.meta.mail||"未登陆"))])]),e("li",[t._v("商品信息："),e("span",[t._v(t._s(t.plan?t.plan.name:"未选择商品"))])]),e("li",[t._v("订单金额："),e("span",[t._v("￥"+t._s(t.plan?t.plan.price:"未选择商品"))])])]),e("div",{staticClass:"pay-type mt-15"},[t._l(Object.keys(t.payTypeList),(function(o,n){return[t.payTypeList[o].enabled?e("el-radio",{key:n,attrs:{label:o,disabled:!t.payTypeList[o].enabled},model:{value:t.payType,callback:function(e){t.payType=e},expression:"payType"}},[e("el-image",{attrs:{src:t.payTypeList[o].icon,alt:""}}),e("span",{staticClass:"pay-type-text"},[t._v(t._s(t.payTypeList[o].name))])],1):t._e()]}))],2),"wxpc"===t.payType&&t.$store.state.isMobile?e("div",{staticClass:"mt-15 tips"},[t._v("\n                    注意：请选择“微信（手机）”进行支付\n                ")]):t._e(),"wxwap"===t.payType?e("div",{staticClass:"mt-15 tips"},[t._v("\n                    注意：若支付失败或无法支付，请联系站长微信【lovesnad】发送红包后购买\n                ")]):t._e(),e("el-button",{staticClass:"mt-15",attrs:{type:"primary"},on:{click:t.submitOrder}},[t._v("\n                    前往支付\n                ")])],1),e("nya-container",{attrs:{title:"说明"}},[e("ul",{staticClass:"nya-list"},[e("li",[t._v("\n                        购买前请阅读： "),e("nuxt-link",{attrs:{to:"/docs"}},[t._v("\n                            帮助文档\n                        ")])],1),e("li",[t._v("需要微信手机支付的可以联系微信：lovesnad 转账")]),e("li",[t._v("站长：QQ 1733708055，微信 lovesnad、邮箱 imiku.me@gmail.com")]),e("li",[e("b",[t._v("如果您已关闭订单但是支付成功，请在用户中心刷新订单状态")])])])])],2)])],1)}),[],!1,null,null,null);e.default=component.exports}}]);